# these variables match values from common/specialist_subject_types/00_specialist_subject_types.txt
@level_2_xp_cost = 1200 # 10 years at 100 Loyalty.
@level_3_xp_cost = 3600 # 30 years at 100 Loyalty.
@specialist_base_conversion_time = 30

specialist_mercatorum = {
	icon = "GFX_diplomacy_specialist_subject_mercatorum"
	icon_large = "GFX_diplomacy_specialist_subject_mercatorum_large"
	preferred_ethic = ethic_xenophile
	base_conversion_time = @specialist_base_conversion_time
	on_progress_complete = {
		print_scope_effect = yes
		target = {
			set_variable = {
				which = num_civics_to_add
				value = 1 # not 2, because the subject is always assigned civic_free_traders
			}
			if = {
				limit = { has_technology = tech_galactic_administration }
				change_variable = {
					which = num_civics_to_add
					value = 1
				}
			}
			# flag for civics that have a (near-)direct corporate equivalent
			set_civic_flag_if_present = { CIVIC = civic_crafters }
			set_civic_flag_if_present = { CIVIC = civic_anglers }
			set_civic_flag_if_present = { CIVIC = civic_pleasure_seekers }
			set_civic_flag_if_present = { CIVIC = civic_slaver_guilds }
			set_civic_flag_if_present = { CIVIC = civic_death_cult }
			set_civic_flag_if_present = { CIVIC = civic_relentless_industrialists }
			set_civic_flag_if_present = { CIVIC = civic_catalytic_processing }
			set_civic_flag_if_present = { CIVIC = civic_scavengers }
			set_civic_flag_if_present = { CIVIC = civic_toxic_baths }
			set_civic_flag_if_present = { CIVIC = civic_reanimated_armies }
			set_civic_flag_if_present = { CIVIC = civic_cutthroat_politics }
			set_civic_flag_if_present = { CIVIC = civic_diplomatic_corps }
			set_civic_flag_if_present = { CIVIC = civic_idealistic_foundation }
			set_civic_flag_if_present = { CIVIC = civic_beacon_of_liberty }
			set_civic_flag_if_present = { CIVIC = civic_citizen_service }
			set_civic_flag_if_present = { CIVIC = civic_warrior_culture }
			set_civic_flag_if_present = { CIVIC = civic_exalted_priesthood }
			set_civic_flag_if_present = { CIVIC = civic_ascensionists }
			set_civic_flag_if_present = { CIVIC = civic_feudal_realm }
			if = {
				limit = { has_halcyon_realms_of_the_marian_polity_active = yes }
				set_civic_flag_if_present = { CIVIC = civic_catalytic_processing_alternate }
			}
			# shift ethics as required for a megacorp - not fanatic authoritarian or fanatic egalitarian
			if = {
				limit = { has_ethic = ethic_fanatic_authoritarian }
				ordered_pop_faction = {
					limit = { NOT = { is_pop_faction_type = totalitarian } }
					order_by = trigger:num_pops
					position = 0
					switch = {
						trigger = is_pop_faction_type
						prosperity = { prev = { shift_ethic = ethic_pacifist } }
						imperialist = { prev = { shift_ethic = ethic_militarist } }
						isolationist = { prev = { shift_ethic = ethic_xenophobe } }
						supremacist = { prev = { shift_ethic = ethic_xenophobe } }
						technologist = { prev = { shift_ethic = ethic_materialist } }
						traditionalist = { prev = { shift_ethic = ethic_spiritualist } }
						xenoist = { prev = { shift_ethic = ethic_xenophile } }
						default = { prev = { shift_ethic = ethic_xenophile } }
					}
				}
			}
			else_if = {
				limit = { has_ethic = ethic_fanatic_egalitarian }
				ordered_pop_faction = {
					limit = {
						NOR = {
							is_pop_faction_type = progressive
							is_pop_faction_type = manifesti
						}
					}
					order_by = trigger:num_pops
					position = 0
					switch = {
						trigger = is_pop_faction_type
						prosperity = { prev = { shift_ethic = ethic_pacifist } }
						imperialist = { prev = { shift_ethic = ethic_militarist } }
						isolationist = { prev = { shift_ethic = ethic_xenophobe } }
						supremacist = { prev = { shift_ethic = ethic_xenophobe } }
						technologist = { prev = { shift_ethic = ethic_materialist } }
						traditionalist = { prev = { shift_ethic = ethic_spiritualist } }
						xenoist = { prev = { shift_ethic = ethic_xenophile } }
						default = { prev = { shift_ethic = ethic_xenophile } }
					}
				}
			}
			change_government = {
				authority = auth_corporate
				civics = { civic = civic_free_traders }
				cooldown = yes
				remove_invalid_civics = yes
			}
			# add equivalent civics
			add_civic_if_flag_present = {
				FLAG = civic_crafters
				CIVIC = civic_corporate_crafters
			}
			add_civic_if_flag_present = {
				FLAG = civic_anglers
				CIVIC = civic_corporate_anglers
			}
			add_civic_if_flag_present = {
				FLAG = civic_pleasure_seekers
				CIVIC = civic_corporate_hedonism
			}
			add_civic_if_flag_present = {
				FLAG = civic_slaver_guilds
				CIVIC = civic_indentured_assets
			}
			add_civic_if_flag_present = {
				FLAG = civic_death_cult
				CIVIC = civic_death_cult_corporate
			}
			add_civic_if_flag_present = {
				FLAG = civic_relentless_industrialists
				CIVIC = civic_corporate_relentless_industrialists
			}
			add_civic_if_flag_present = {
				FLAG = civic_catalytic_processing
				CIVIC = civic_corporate_catalytic_processing
			}
			add_civic_if_flag_present = {
				FLAG = civic_scavengers
				CIVIC = civic_corporate_scavengers
			}
			add_civic_if_flag_present = {
				FLAG = civic_toxic_baths
				CIVIC = civic_corporate_toxic_baths
			}
			add_civic_if_flag_present = {
				FLAG = civic_reanimated_armies
				CIVIC = civic_permanent_employment
			}
			add_civic_if_flag_present = {
				FLAG = civic_cutthroat_politics
				CIVIC = civic_ruthless_competition
			}
			add_civic_if_flag_present = {
				FLAG = civic_diplomatic_corps
				CIVIC = civic_public_relations_specialists
			}
			add_civic_if_flag_present = {
				FLAG = civic_idealistic_foundation
				CIVIC = civic_media_conglomerate
			}
			add_civic_if_flag_present = {
				FLAG = civic_beacon_of_liberty
				CIVIC = civic_brand_loyalty
			}
			add_civic_if_flag_present = {
				FLAG = civic_citizen_service
				CIVIC = civic_naval_contractors
			}
			add_civic_if_flag_present = {
				FLAG = civic_warrior_culture
				CIVIC = civic_private_military_companies
			}
			add_civic_if_flag_present = {
				FLAG = civic_exalted_priesthood
				CIVIC = civic_gospel_of_the_masses
			}
			add_civic_if_flag_present = {
				FLAG = civic_ascensionists
				CIVIC = civic_corporate_ascensionists
			}
			add_civic_if_flag_present = {
				FLAG = civic_feudal_realm
				CIVIC = civic_franchising
			}
			# cleanup all possible flags from above
			remove_country_flag = civic_crafters
			remove_country_flag = civic_anglers
			remove_country_flag = civic_pleasure_seekers
			remove_country_flag = civic_slaver_guilds
			remove_country_flag = civic_death_cult
			remove_country_flag = civic_relentless_industrialists
			remove_country_flag = civic_catalytic_processing
			remove_country_flag = civic_scavengers
			remove_country_flag = civic_toxic_baths
			remove_country_flag = civic_reanimated_armies
			remove_country_flag = civic_cutthroat_politics
			remove_country_flag = civic_diplomatic_corps
			remove_country_flag = civic_idealistic_foundation
			remove_country_flag = civic_beacon_of_liberty
			remove_country_flag = civic_citizen_service
			remove_country_flag = civic_warrior_culture
			remove_country_flag = civic_exalted_priesthood
			remove_country_flag = civic_ascensionists
			remove_country_flag = civic_feudal_realm
			# backup civics in case points remain unspent - no more than 2 can ever be added, so a minimum of two fallbacks are needed
			# (repeats are ok because they would have transferred above if the non-corporate "equivalent" was present)
			add_civic_if_not_present = { CIVIC = civic_corporate_crafters } # only available with Humanoids Species Pack
			add_civic_if_not_present = { CIVIC = civic_public_relations_specialists }
			add_civic_if_not_present = { CIVIC = civic_trading_posts }
			# handle the special early catalytic bonus civic lat, because it has a net 0 cost
			if = {
				limit = {
					has_halcyon_realms_of_the_marian_polity_active = yes
					has_country_flag = civic_catalytic_processing_alternate
				}
				force_add_civic = civic_corporate_catalytic_processing_alternate
			}
			clear_variable = num_civics_to_add
		}
	}
	levels = {
		# Level 1
		{
			experience_needed_for_next_level = @level_2_xp_cost
			perks = {
				mercatorum_1_modifier
				mercatorum_1_penalties
				mercatorum_1_econ_tech
				mercatorum_1_overlord_modifier
				# mercatorum_1_overlord_dividends
				mercatorum_1_neighbor_bonuses
				mercatorum_1_branch_office_bonuses
			}
		}
		# Level 2
		{
			experience_needed_for_next_level = @level_3_xp_cost
			perks = {
				mercatorum_2_modifier
				mercatorum_2_penalties
				mercatorum_2_econ_tech
				mercatorum_2_traits
				mercatorum_2_leaders
			}
		}
		# Level 3
		{
			perks = {
				mercatorum_3_modifier
				mercatorum_3_penalties
				mercatorum_3_econ_tech
			}
		}
	}
}